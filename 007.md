# PANEL 007 - CONSTRUCTOR DE TAREAS

> **Instruccion para iniciar:** Escribe `start 007.md` para ver este panel

---

## ESTADO ACTUAL DEL PROYECTO (Actualizado: 8 Diciembre 2025)

### ESTRUCTURA ACTUAL

**IMPORTANTE:** Los endpoints principales siguen en `app.py` (15,337 lineas).
La migracion a blueprints esta en progreso de forma gradual.

**Estado de Blueprints:**
- `routes/auth_routes.py` - Preparado, endpoint /health activo
- `routes/blockchain_routes.py` - Preparado, endpoint /health activo
- `routes/admin_routes.py` - Preparado, endpoint /health activo
- `routes/user_routes.py` - Preparado, endpoint /health activo

**Modulo de utilidades compartidas:**
- `tracking/utils.py` - InputValidator, RateLimiter, sanitize_error

---

## COMANDOS DISPONIBLES

| # | Comando | Descripcion |
|---|---------|-------------|
| **1** | Crear Nuevas Tareas | Escucho lo que necesitas y lo agrego al agente correcto |
| **2** | Agente Backend-API | `WORK/TAREAS_BACKEND-API.md` - Endpoints, modelos, base de datos |
| **3** | Agente Blockchain-Services | `WORK/TAREAS_BLOCKCHAIN-SERVICES.md` - TON, wallets, servicios externos |
| **4** | Agente Frontend-Admin | `WORK/TAREAS_FRONTEND-ADMIN.md` - Panel admin, admin.js, admin.css |
| **5** | Agente Frontend-User | `WORK/TAREAS_FRONTEND-USER.md` - App usuario, app.js, styles.css |

---

## INSTRUCCIONES POR COMANDO

### COMANDO 1: CREAR NUEVAS TAREAS

**Objetivo:** Entender PERFECTAMENTE lo que el usuario quiere antes de crear la tarea.

**Flujo Obligatorio:**

#### PASO 1: ESCUCHAR
El usuario describe lo que quiere (ej: "no me gusta esta seccion", "quiero agregar esto", "esto no funciona")

#### PASO 2: PREGUNTAR (OBLIGATORIO)
Antes de crear cualquier tarea, hacer TODAS las preguntas necesarias para entender:

**Preguntas de Contexto:**
- Donde exactamente esta el problema? (URL, seccion, pantalla)
- Que ves actualmente vs que esperabas ver?
- Es un bug o una mejora/feature nueva?

**Preguntas de Alcance:**
- Quieres que se elimine, modifique o agregue algo?
- Hay algun diseno o referencia que quieras seguir?
- Esto afecta solo a usuarios, solo a admin, o ambos?

**Preguntas de Prioridad:**
- Que tan urgente es esto? (Critico/Alto/Medio/Bajo)
- Hay algo que dependa de esto?

**Preguntas Tecnicas (si aplica):**
- Hay datos que se deben guardar/mostrar?
- Necesita conectarse con algun endpoint existente?
- Hay validaciones especificas?

> **REGLA:** No hay limite de preguntas. Es mejor preguntar de mas que crear una tarea incompleta o mal entendida.

#### PASO 3: CONFIRMAR ENTENDIMIENTO
Antes de crear la tarea, resumir lo que entendi:
```
Entiendo que quieres:
- [Descripcion clara del cambio]
- Afecta a: [usuarios/admin/ambos]
- Prioridad: [nivel]
- Archivos involucrados: [lista]

Es correcto? Falta algo?
```

#### PASO 4: ASIGNAR AGENTE
Analizar a que agente corresponde segun los archivos:
- Si toca `app.py`, `database.py`, `models.py` -> Backend-API
- Si toca `wallet`, `b3c`, `encryption` -> Blockchain-Services
- Si toca `admin.js`, `admin.css`, `admin.html` -> Frontend-Admin
- Si toca `app.js`, `styles.css`, `index.html` -> Frontend-User

> **IMPORTANTE:** Si la tarea requiere cambios en multiples agentes, dividirla en sub-tareas para cada uno.

#### PASO 5: CREAR LA TAREA
Agregar al archivo `.md` correcto con formato:
```markdown
### FASE XX.X: [NOMBRE DESCRIPTIVO] - [PRIORIDAD]
**Tiempo estimado:** Xh
**Fecha creacion:** [fecha]
**Solicitado por:** Usuario

**Contexto:**
[Descripcion del problema o necesidad]

**Tareas:**
- [ ] Tarea especifica 1
- [ ] Tarea especifica 2
- [ ] Tarea especifica 3

**Criterios de aceptacion:**
- [ ] [Que debe cumplirse para considerar la tarea terminada]
```

#### PASO 6: CONFIRMAR
Mostrar la tarea creada y a que agente fue asignada.

---

**Regla importante:** Los agentes NO pueden pisarse. Cada uno tiene sus propios archivos.

---

### COMANDOS 2-5: EJECUTAR AGENTE

**Flujo obligatorio:**

1. **Leer tareas pendientes** del archivo correspondiente
2. **Mostrar tareas pendientes** con prioridad
3. **Ejecutar tareas** una por una siguiendo el orden de prioridad
4. **Al finalizar cada tarea**, verificar que funciona correctamente

---

## ASIGNACION DE AGENTES

### AGENTE 2: Backend-API
**Archivos:**
- app.py (endpoints principales - migracion gradual)
- routes/__init__.py
- routes/auth_routes.py (endpoints de autenticacion y 2FA)
- tracking/__init__.py
- tracking/database.py
- tracking/models.py
- tracking/utils.py (utilidades compartidas)
- tracking/email_service.py
- tracking/security.py
- tracking/telegram_service.py
- init_db.py
- seed_data.py
- run.py
- runtime.txt
- requirements.txt

---

### AGENTE 3: Blockchain-Services
**Archivos:**
- routes/blockchain_routes.py (endpoints /api/b3c/*, /api/wallet/*)
- tracking/b3c_service.py
- tracking/wallet_pool_service.py
- tracking/deposit_scheduler.py
- tracking/smspool_service.py
- tracking/legitsms_service.py
- tracking/cloudinary_service.py
- tracking/encryption.py

---

### AGENTE 4: Frontend-Admin
**Archivos:**
- routes/admin_routes.py (endpoints /api/admin/*)
- static/js/admin.js
- static/js/admin-utils.js (utilidades especificas de admin)
- static/css/admin.css
- templates/admin.html

---

### AGENTE 5: Frontend-User
**Archivos:**
- routes/user_routes.py (endpoints /api/users/*, /api/publications/*)
- static/js/app.js
- static/js/publications.js
- static/js/virtual-numbers.js
- static/js/utils.js
- static/css/styles.css
- templates/index.html
- templates/virtual_numbers.html
- templates/access_denied.html

---

### ARCHIVOS COMPARTIDOS (SOLO LECTURA)
**Regla:** Ningun agente puede modificar estos archivos
- static/js/shared-utils.js (utilidades comunes)

---

## RESUMEN RAPIDO DE TAREAS PENDIENTES

| Agente | Archivo | Estado | Horas Est. |
|--------|---------|--------|------------|
| Backend-API | WORK/TAREAS_BACKEND-API.md | 70% completado | ~17h pendientes |
| Blockchain | WORK/TAREAS_BLOCKCHAIN-SERVICES.md | En progreso | ~48h pendientes |
| Frontend-Admin | WORK/TAREAS_FRONTEND-ADMIN.md | En progreso | ~60h pendientes |
| Frontend-User | WORK/TAREAS_FRONTEND-USER.md | En progreso | ~33h pendientes |

---

## COMO USAR

Escribe el numero del comando que quieres ejecutar:

- `1` - Para agregar nuevas tareas
- `2` - Para trabajar en Backend-API
- `3` - Para trabajar en Blockchain-Services
- `4` - Para trabajar en Frontend-Admin
- `5` - Para trabajar en Frontend-User

---

## REGLAS IMPORTANTES

1. **No mezclar archivos:** Cada agente solo toca sus archivos asignados
2. **Prioridades:** Seguir el orden recomendado en cada archivo de tareas
   - Rojo = Critico
   - Amarillo = Alta
   - Naranja = Media
   - Verde = Baja

---

# REGLAS DE CONSTRUCCION - CERO TOLERANCIA A FALLOS

## 1. ANTES DE COMENZAR CUALQUIER TAREA

- [ ] Leer el archivo completo que voy a modificar
- [ ] Entender el contexto y las dependencias
- [ ] Verificar que no hay errores previos en el codigo
- [ ] Identificar patrones existentes para seguirlos

---

## 2. DURANTE LA CONSTRUCCION

### Codigo Limpio:
- [ ] No dejar `console.log` en produccion (usar Logger)
- [ ] No dejar comentarios tipo `// TODO` o `// FIXME` sin resolver
- [ ] No dejar codigo comentado sin proposito
- [ ] Nombres de variables/funciones descriptivos en ingles
- [ ] Funciones pequenas y con un solo proposito

### Seguridad Obligatoria:
- [ ] Validar TODOS los inputs del usuario
- [ ] Escapar HTML para prevenir XSS (`html.escape()`)
- [ ] No exponer errores internos al usuario (usar `sanitize_error`)
- [ ] No hardcodear tokens, keys o secretos
- [ ] Usar parametros preparados en SQL (nunca concatenar strings)
- [ ] Verificar permisos antes de cada accion sensible
- [ ] Rate limiting en endpoints criticos

### Manejo de Errores:
- [ ] Try/catch en todas las operaciones async
- [ ] Mensajes de error claros para el usuario
- [ ] Logging de errores con contexto (request_id, user_id, ip)
- [ ] Retornar codigos HTTP correctos (400, 401, 403, 404, 500)

---

## 3. ANTES DE DAR POR TERMINADA UNA TAREA

### Verificaciones Obligatorias:
- [ ] El codigo compila/ejecuta sin errores
- [ ] No hay errores en los logs del servidor
- [ ] La funcionalidad hace lo que se pidio
- [ ] No se rompio nada existente
- [ ] Los endpoints retornan respuestas correctas

### Testing Manual:
- [ ] Probar el caso exitoso (happy path)
- [ ] Probar con datos invalidos
- [ ] Probar sin autenticacion (debe rechazar)
- [ ] Probar con usuario sin permisos (debe rechazar)

---

## 4. PROHIBICIONES ABSOLUTAS

| Prohibido | Razon |
|-----------|-------|
| Datos mock/placeholder en produccion | Confunde al usuario |
| `eval()` o `exec()` con input del usuario | Vulnerabilidad critica |
| SQL sin parametros preparados | SQL Injection |
| Mostrar stack traces al usuario | Fuga de informacion |
| Guardar passwords en texto plano | Vulnerabilidad critica |
| Ignorar errores con `except: pass` | Oculta problemas |
| Commits sin probar el codigo | Rompe la rama |

---

## 5. PATRON DE RESPUESTA API

Todas las respuestas deben seguir este formato:

**Exito:**
```json
{
  "success": true,
  "data": { ... }
}
```

**Error:**
```json
{
  "success": false,
  "error": "Mensaje amigable para el usuario"
}
```

---

## 6. CHECKLIST FINAL ANTES DEL COMMIT

```
[ ] El codigo funciona correctamente
[ ] No hay errores en consola/logs
[ ] Los inputs estan validados
[ ] Los errores estan manejados
[ ] No hay datos sensibles expuestos
[ ] El codigo sigue los patrones existentes
[ ] Reinicie el workflow y verifique que corre
```

---

## 7. SI ALGO FALLA

1. **NO AVANZAR** hasta que este resuelto
2. Leer el error completo
3. Buscar la causa raiz (no solo el sintoma)
4. Arreglar el problema
5. Verificar que no se rompio otra cosa
6. Solo entonces continuar

---

## 8. FLUJO DE TRABAJO SEGURO

```
LEER TAREA
    |
    v
LEER ARCHIVOS RELACIONADOS
    |
    v
IDENTIFICAR CAMBIOS NECESARIOS
    |
    v
IMPLEMENTAR (siguiendo patrones existentes)
    |
    v
VERIFICAR QUE FUNCIONA
    |
    v
VERIFICAR QUE NO ROMPIO NADA
    |
    v
REINICIAR WORKFLOW
    |
    v
VERIFICAR LOGS SIN ERRORES
    |
    v
SIGUIENTE TAREA
```

---

## NOTAS DE ARQUITECTURA

### Estructura de Rutas
Los archivos en `routes/` estan preparados para recibir endpoints migrados desde app.py.
Cada archivo tiene un endpoint `/health` para verificar que esta activo.

### Modulo de Utilidades
`tracking/utils.py` contiene clases y funciones compartidas:
- `InputValidator` - Validacion y sanitizacion de inputs
- `RateLimiter` - Control de rate limiting
- `sanitize_error()` - Sanitizacion de errores

### Endpoints Actuales
Todos los endpoints principales estan en `app.py`.
La migracion a blueprints separados se hara de forma gradual
para evitar romper funcionalidad existente.
